<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Banking App</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        min-height: 100vh;
        font-family: "Montserrat", sans-serif;
        background-color: #e3f2fd;
      }
      .container {
        min-width: 576px;
      }
      .card {
        width: 100%;
      }
      .card-header {
        background: linear-gradient(90deg, #3c72ff 0%, #37cfff 100%);
        color: white;
      }
      .nav-link {
        cursor: pointer;
      }
      .form-group {
        width: 100%;
      }
      .rotate-90 {
        transform: rotate(90deg);
      }
      .rotate-neg90 {
        transform: rotate(-90deg);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg justify-content-between">
      <div class="container">
        <a class="btn rounded-circle btn-outline-primary" href="/"
          ><i class="fas fa-arrow-left"></i
        ></a>
        <button class="btn btn-outline-primary float-right" id="sign-out">
          <i class="fas fa-sign-out-alt"></i>
          Sign out
        </button>
      </div>
    </nav>
    <div
      class="container d-flex justify-content-center align-items-center flex-column mb-5"
    >
      <div class="card w-100 shadow border-0 mt-5">
        <div class="card-header">
          <h4 class="text-center m-0">User Bank Account</h4>
        </div>
        <div class="card-body">
          <div class="row rounded">
            <div class="col-md-6">
              <strong class="text-secondary">Account Name:</strong><br />
              <h4 id="name_display">---</h4>
            </div>
            <div class="col-md-6">
              <strong class="text-secondary">Balance:</strong><br />
              <h4 id="balance_display">---</h4>
            </div>
          </div>

          <div class="mt-5">
            <ul class="nav nav-tabs" id="myTab">
              <li class="nav-item">
                <a class="nav-link active" data-tab="deposit">Deposit</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-tab="withdraw">Withdraw</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-tab="send">Send Money</a>
              </li>
            </ul>
            <div
              class="tab-content border-left border-bottom border-right px-3 py-5"
              id="myTabContent"
            >
              <div class="tab-pane fade show active" data-tab="deposit">
                <div class="h-100">
                  <div class="row">
                    <div class="col-md-6 d-flex align-items-center">
                      <div class="form-group">
                        <label for="deposit_amount"
                          ><strong>Amount</strong>
                        </label>
                        <div
                          class="position-relative d-flex align-items-center"
                        >
                          <small class="position-absolute mx-2 text-secondary"
                            >PHP</small
                          >
                          <input
                            type="number"
                            id="deposit_amount"
                            class="form-control pl-5"
                            placeholder="Enter amount"
                          />
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 d-flex align-items-center">
                      <button class="btn btn-primary w-100 mt-3" id="deposit">
                        <i class="fas fa-sign-in-alt mr-2 rotate-90"></i>
                        Deposit
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" data-tab="withdraw">
                <div class="h-100">
                  <div class="row">
                    <div class="col-md-6 d-flex align-items-center">
                      <div class="form-group">
                        <label for="withdraw_amount"
                          ><strong>Amount</strong>
                        </label>
                        <div
                          class="position-relative d-flex align-items-center"
                        >
                          <small class="position-absolute mx-2 text-secondary"
                            >PHP</small
                          >
                          <input
                            type="number"
                            id="withdraw_amount"
                            class="form-control pl-5"
                            placeholder="Enter amount"
                          />
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 d-flex align-items-center">
                      <button class="btn btn-primary w-100 mt-3" id="withdraw">
                        <i class="fas fa-sign-out-alt mr-2 rotate-neg90"></i>
                        Withdraw
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" data-tab="send">
                <div class="h-100">
                  <div class="row">
                    <div class="col-md-4 d-flex align-items-center">
                      <div class="form-group">
                        <label for="send_amount"
                          ><strong>Amount</strong>
                        </label>
                        <div
                          class="position-relative d-flex align-items-center"
                        >
                          <small class="position-absolute mx-2 text-secondary"
                            >PHP</small
                          >
                          <input
                            type="number"
                            id="send_amount"
                            class="form-control pl-5"
                            placeholder="Enter amount"
                          />
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4 d-flex align-items-center">
                      <div class="form-group">
                        <label for="recepient"
                          ><strong>Recepient</strong>
                        </label>
                        <select class="form-control w-100" id="recepient">
                          <option value="" disabled selected hidden>
                            Select recepient
                          </option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-4 d-flex align-items-center">
                      <button class="btn btn-primary w-100 mt-3" id="send">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Send
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script type="module">
      if (document.cookie.indexOf("adminuser=Valid") == -1) {
        location.href = "/index_login.html";
      }

      import { show, deposit, withdraw, send, list_users } from "./backend.js";

      const nav_link_element = document.querySelectorAll(".nav-link");
      const tab_pane_element = document.querySelectorAll(".tab-pane");
      const name_display_element = document.getElementById("name_display");
      const balance_display_element = document.getElementById(
        "balance_display"
      );
      const deposit_amount_element = document.getElementById("deposit_amount");

      const withdraw_amount_element = document.getElementById(
        "withdraw_amount"
      );

      const send_amount_element = document.getElementById("send_amount");
      const recepient_element = document.getElementById("recepient");

      const url = new URL(location);
      const params = new URLSearchParams(url.search.slice(1));
      const name = params.get("name");

      //click listener for tabs
      for (const nav_link of nav_link_element) {
        nav_link.addEventListener("click", (e) => {
          for (const nav_link of nav_link_element) {
            nav_link.classList.remove("active");
          }
          for (const tab_pane of tab_pane_element) {
            if (tab_pane.dataset.tab === e.target.dataset.tab) {
              tab_pane.classList.add("active");
              tab_pane.classList.add("show");
            } else {
              tab_pane.classList.remove("active");
              tab_pane.classList.remove("show");
            }
          }
          nav_link.classList.add("active");
        });
      }
      //click listener
      document
        .getElementById("deposit")
        .addEventListener("click", deposit_money);
      document
        .getElementById("withdraw")
        .addEventListener("click", withdraw_money);
      document.getElementById("send").addEventListener("click", send_money);

      function display_user_account() {
        const user_account = show(name);
        if (user_account) {
          name_display_element.innerHTML = user_account.name;
          balance_display_element.innerHTML = user_account.balance;
        }
      }

      function show_select_option_names() {
        let user_accounts = list_users();
        user_accounts = user_accounts.filter((user_account) => {
          return !(user_account.name === name);
        });
        const user_account_name_option = user_accounts.map((user_account) => {
          user_account.name !== name;
          return `
            <option value='${user_account.name}'>${user_account.name}</option>
          `;
        });
        user_account_name_option.forEach((element) => {
          recepient_element.innerHTML += element;
        });
      }

      function clear_inputs() {
        deposit_amount_element.value = "";
        withdraw_amount_element.value = "";
        send_amount_element.value = "";
        recepient_element.value = "";
      }

      function send_money() {
        const { success, message, data } = send(
          name,
          recepient_element.value,
          send_amount_element.value
        );
        if (success) {
          Swal.fire({
            title: message,
            html: `
            <div class="row pb-1 pt-4">
                <div class="col-md-6 d-flex"><strong>${data.from.name}</strong></div>
                <div class="col-md-6"><strong><span class='text-secondary'>Balance:</span> ${data.from.balance}</strong></div>
            </div><hr/>
            <div class="row py-1">
                <div class="col-md-6 d-flex"><strong>${data.to.name}</strong></div>
                <div class="col-md-6"><strong><span class='text-secondary'>Balance:</span> ${data.to.balance}</strong></div>
            </div>

            `,
            icon: "success",
          });
        } else {
          Swal.fire({
            title: message,
            icon: "error",
          });
        }
        display_user_account();
        clear_inputs();
      }

      function deposit_money() {
        const { success, message, data } = deposit(
          name,
          deposit_amount_element.value
        );
        if (success) {
          Swal.fire({
            title: message,
            html: `
            <div class="row pb-1 pt-4">
                <div class="col-md-6 d-flex"><strong>${data.name}</strong></div>
                <div class="col-md-6"><strong><span class='text-secondary'>Balance:</span> ${data.balance}</strong></div>
            </div>
            `,
            icon: "success",
          });
        } else {
          Swal.fire({
            title: message,
            icon: "error",
          });
        }
        display_user_account();
        clear_inputs();
      }

      function withdraw_money() {
        const { success, message, data } = withdraw(
          name,
          withdraw_amount_element.value
        );
        if (success) {
          Swal.fire({
            title: message,
            html: `
            <div class="row pb-1 pt-4">
                <div class="col-md-6 d-flex"><strong>${data.name}</strong></div>
                <div class="col-md-6"><strong><span class='text-secondary'>Balance:</span> ${data.balance}</strong></div>
            </div>
            `,
            icon: "success",
          });
        } else {
          Swal.fire({
            title: message,
            icon: "error",
          });
        }
        display_user_account();
        clear_inputs();
      }
      (function init() {
        display_user_account();
        show_select_option_names();
      })();

      document
        .getElementById("sign-out")
        .addEventListener("click", function () {
          Swal.fire({
            title: "Are you sure?",
            text: "You want to Sign-out?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes!",
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.assign("index_login.html");
              document.cookie = "adminuser=Valid" + ";max-age=0";
              cookie1 = document.cookie;
            }
          });
        });
    </script>
  </body>
</html>
